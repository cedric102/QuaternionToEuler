<!-- https://www.therogerlab.com/how-can-i/javascript/read-a-csv.html#readCSV 
     https://stackoverflow.com/questions/2075337/uncaught-referenceerror-is-not-defined
     https://gist.github.com/tanvir002700/c65f5c6608c16540a72688f011cf2485
     https://www.w3schools.com/php/php_file_upload.asp
-->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script src="https://www.chartjs.org/dist/2.9.4/Chart.min.js"></script>
<script src="https://www.chartjs.org/samples/latest/utils.js"></script>

<html>
<head>
	<style>
	canvas{
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>
<body>
	<div id="QuatCanvas">
		<canvas id="canvas2"></canvas>
	</div>
	<div id="EulerCanvas">
		<canvas id="canvas"></canvas>
	</div>

<!--	<button id="randomizeData">Randomize Data</button>	-->
	<div id="Instructions">
<b>CONVERT QUATERNIONS TO EULER WITH A CSV FORMAT.<br>
ie:</b><br>
0.5 , 0.5 , 0.5 , 0 , <br>
0.5 , 0 , 0 , 0 ,<br>
0.5 , 1 , 0 , 0 ,<br>
-0.0194 , -0.02352 , -0.000186 , 0.999534 ,<br>
0.5 , 0 , 0 , 1 ,<br>
-0.0194 , -0.02352 , -0.000186 , 0.599534 ,<br>
-0.0194 , -0.02352 , -0.000186 , 0.999534 ,<br>
-0.0194 , -0.02352 , -0.000186 , 0.999534 ,<br>
-0.0194 , -0.02352 , -0.000186 , 0.599534 ,<br>
-0.0194 , -0.02352 , -0.000186 , 0.599534 ,<br>
-0.0194 , -0.02352 , -0.000186 , 0.599534 , <br><br>
	</div>
	<div style="display: inline-block;">
		<input type="file" name="filename" id="filename">
		<button id="upload" style="display: block;">upload</button>
	</div>
	<div style="display: inline-block;">
		<textarea id="QuaternonListDivison" name="QuaternonListDivison" style="width: 500px; white-space: pre-wrap;"></textarea>
		<button id="QuaternionListButton" style="display: block;">Use Quaternion List Above</button>
	</div>
	<div>
		<div style="background-color: grey; margin-top: 10px;" id="csvQuat"></div>
		<div style="background-color: grey; margin-top: 10px;" id="csv"></div>
	</div>

	<script>https://github.com/mozilla/webextension-polyfill
		//this is the 1st way.

		var datapoints1 = [ 1 , 100 , 50 ];
		var datapoints2 = [ 2 , 50 , -30 ];
		var datapoints3 = [ 3 , -20 , 50 ];

		var Quatpoints1 = [ 0.5 , 0.5 , 0.5 , 0 , ];
		var Quatpoints2 = [ 0.5 , 0 , 0 , 0 , ];
		var Quatpoints3 = [ 0.5 , 1 , 0 , 0 , ];
		var Quatpoints4 = [ -0.0194 , -0.02352 , -0.000186 , 0.999534 , ];
		var minimumQ = -1.5;
		var maximumQ = 1.5;
		var minimumE = -200;
		var maximumE = 200;
		
		var labelString = [ 0 , 1 , 2 ];

		$(document).ready(function(){
			$('#upload').click(function(){
				while (datapoints1.length) { datapoints1.pop(); }
				while (datapoints2.length) { datapoints2.pop(); }
				while (datapoints3.length) { datapoints3.pop(); }

				while (Quatpoints1.length) { Quatpoints1.pop(); }
				while (Quatpoints2.length) { Quatpoints2.pop(); }
				while (Quatpoints3.length) { Quatpoints3.pop(); }
				while (Quatpoints4.length) { Quatpoints4.pop(); }

				minimumQ = 9999;
				maximumQ = -9999;

				minimumE = 9999;
				maximumE = -9999;

				var csv = $('#filename');
				var csvFile = csv[0].files[0];
				var ext = csv.val().split(".").pop().toLowerCase();

				if($.inArray(ext, ["csv"]) === -1){
					alert('upload csv');
					return false;
				}
				if(csvFile != undefined){
					reader = new FileReader();
					reader.readAsText(csvFile);
					reader.onload = function(e){
						document.getElementById("csvQuat").innerHTML = "<b>| => QUATERNION CSV FORMAT :</b> <br>";
						document.getElementById("csv").innerHTML = "<b>| => EULER CSV FORMAT :</b> <br>";
						csvResult = e.target.result;
						var rows = csvResult.split('\n');
    						//move line by line
						console.log( rows );
    						for (var i = 0; i < rows.length-1; i++) {
      							//split by separator (,) and get the columns
      							cols = rows[i].split(',');
							console.log( cols );
							for (var j = 0; j < cols.length; j++) {
	 							/*the value of the current column.       								Do whatever you want with the value*/
								console.log( cols[j] );
							}
//							document.getElementById("csv").innerHTML = document.getElementById("csv").innerHTML + "<br>" +  cols;

							qw = cols[0];
							qx = cols[1];
							qy = cols[2];
							qz = cols[3];


							heading = Math.atan( ( 2*qy*qw-2*qx*qz ) / ( 1 - 2*qy*qy - 2*qz*qz ) );

							test = qx*qy + qz*qw;

							attitude = Math.asin(2*test);
							bank = Math.atan( ( 2*qx*qw-2*qy*qz ) / ( 1 - 2*qx*qx - 2*qz*qz ) );


							if (test > 0.499) { // singularity at north pole
								heading = 2 * Math.atan(qx/qw);
								attitude = 3.14/2;
								bank = 0;
							}
							if (test < -0.499) { // singularity at south pole
								heading = -2 * Math.atan(qx/qw);
								attitude = - 3.14/2;
								bank = 0;
							}
							console.log( qw + " , " + qx + " , " + qy + " , " + qz );
							heading=heading*360/6.28;
							attitude=attitude*360/6.28;
							bank=bank*360/6.28
							console.log( heading + " , " + attitude + " , " + bank );

							document.getElementById("csvQuat").innerHTML = document.getElementById("csvQuat").innerHTML +  qw + " , " + qx + " , " + qy + " , " + qz + " , <br>";
							document.getElementById("csv").innerHTML = document.getElementById("csv").innerHTML +  heading + " , " + attitude + " , " + bank + " , <br>";
							datapoints1.push(heading);
							datapoints2.push(attitude);
							datapoints3.push(bank);
							minimumE = Math.min(minimumE , heading);
							minimumE = Math.min(minimumE , attitude);
							minimumE = Math.min(minimumE , bank);
							maximumE = Math.max(maximumE , heading);
							maximumE = Math.max(maximumE , attitude);
							maximumE = Math.max(maximumE , bank);

							Quatpoints1.push(qw);
							Quatpoints2.push(qx);
							Quatpoints3.push(qy);
							Quatpoints4.push(qz);
							minimumQ = Math.min(minimumQ , qw);
							minimumQ = Math.min(minimumQ , qx);
							minimumQ = Math.min(minimumQ , qy);
							minimumQ = Math.min(minimumQ , qz);
							maximumQ = Math.max(maximumQ , qw);
							maximumQ = Math.max(maximumQ , qx);
							maximumQ = Math.max(maximumQ , qy);
							maximumQ = Math.max(maximumQ , qz);

							console.log(datapoints1);
							console.log(datapoints2);
							console.log(datapoints3);
						}
						while (labelString.length) { labelString.pop(); }
						if( datapoints1.length < 2 ) {
							datapoints1.push(datapoints1[datapoints1.length-1]);
							datapoints2.push(datapoints2[datapoints2.length-1]);
							datapoints3.push(datapoints3[datapoints3.length-1]);
							labelString.push(0);
							labelString.push(1);
						} else
							for(var stringLoop = 0 ; stringLoop < datapoints1.length ; stringLoop++ )
								labelString.push(stringLoop);
	
						console.log(labelString);
						window.myLine.update();
						window.myLine2.update();
					}
				}

			});
			
			$('#QuaternionListButton').click(function(){
				while (datapoints1.length) { datapoints1.pop(); }
				while (datapoints2.length) { datapoints2.pop(); }
				while (datapoints3.length) { datapoints3.pop(); }

				while (Quatpoints1.length) { Quatpoints1.pop(); }
				while (Quatpoints2.length) { Quatpoints2.pop(); }
				while (Quatpoints3.length) { Quatpoints3.pop(); }
				while (Quatpoints4.length) { Quatpoints4.pop(); }

				minimumQ = 9999;
				maximumQ = -9999;

				minimumE = 9999;
				maximumE = -9999;

				document.getElementById("csvQuat").innerHTML = "<b>| => QUATERNION CSV FORMAT :</b> <br>";
				document.getElementById("csv").innerHTML = "<b>| => EULER CSV FORMAT :</b> <br>";
//				document.getElementById("csv").innerHTML = document.getElementById("QuaternonListDivison").value;
				var tempVal = document.getElementById("QuaternonListDivison").value;
				tempVal = tempVal.replace(/\n/g, '<br>\n');
				var matrixCSV = tempVal.split("<br>\n");
				for( var matrixLoop = 0 ; matrixLoop < matrixCSV.length ; matrixLoop++ ) {
					var innermatrixCSV = matrixCSV[matrixLoop].split(",");
					if( innermatrixCSV.length !== 5 )
						alert( "Line " + ( matrixLoop+1 ) + " Needs 4 components");
					for( var innerMatrixLoop = 0 ; innerMatrixLoop < innermatrixCSV.length ; innerMatrixLoop++ ) {
						console.log(matrixLoop + " ; " + innerMatrixLoop + " ; " + innermatrixCSV[innerMatrixLoop]);
					}
							qw = innermatrixCSV[0];
							qx = innermatrixCSV[1];
							qy = innermatrixCSV[2];
							qz = innermatrixCSV[3];


							heading = Math.atan( ( 2*qy*qw-2*qx*qz ) / ( 1 - 2*qy*qy - 2*qz*qz ) );

							test = qx*qy + qz*qw;

							attitude = Math.asin(2*test);
							bank = Math.atan( ( 2*qx*qw-2*qy*qz ) / ( 1 - 2*qx*qx - 2*qz*qz ) );


							if (test > 0.499) { // singularity at north pole
								heading = 2 * Math.atan(qx/qw);
								attitude = 3.14/2;
								bank = 0;
							}
							if (test < -0.499) { // singularity at south pole
								heading = -2 * Math.atan(qx/qw);
								attitude = - 3.14/2;
								bank = 0;
							}
							console.log( qw + " , " + qx + " , " + qy + " , " + qz );
							heading=heading*360/6.28;
							attitude=attitude*360/6.28;
							bank=bank*360/6.28
							console.log( heading + " , " + attitude + " , " + bank );

							document.getElementById("csvQuat").innerHTML = document.getElementById("csvQuat").innerHTML +  qw + " , " + qx + " , " + qy + " , " + qz + " , <br>";
							document.getElementById("csv").innerHTML = document.getElementById("csv").innerHTML +  heading + " , " + attitude + " , " + bank + " , <br>";

							datapoints1.push(heading);
							datapoints2.push(attitude);
							datapoints3.push(bank);
							minimumE = Math.min(minimumE , heading);
							minimumE = Math.min(minimumE , attitude);
							minimumE = Math.min(minimumE , bank);
							maximumE = Math.max(maximumE , heading);
							maximumE = Math.max(maximumE , attitude);
							maximumE = Math.max(maximumE , bank);

							Quatpoints1.push(qw);
							Quatpoints2.push(qx);
							Quatpoints3.push(qy);
							Quatpoints4.push(qz);
							minimumQ = Math.min(minimumQ , qw);
							minimumQ = Math.min(minimumQ , qx);
							minimumQ = Math.min(minimumQ , qy);
							minimumQ = Math.min(minimumQ , qz);
							maximumQ = Math.max(maximumQ , qw);
							maximumQ = Math.max(maximumQ , qx);
							maximumQ = Math.max(maximumQ , qy);
							maximumQ = Math.max(maximumQ , qz);

							console.log(heading);
							console.log(attitude);
							console.log(bank);
				}
						while (labelString.length) { labelString.pop(); }
						if( datapoints1.length < 2 ) {
							datapoints1.push(datapoints1[datapoints1.length-1]);
							datapoints2.push(datapoints2[datapoints2.length-1]);
							datapoints3.push(datapoints3[datapoints3.length-1]);
							Quatpoints1.push(Quatpoints1[Quatpoints1.length-1]);
							Quatpoints2.push(Quatpoints2[Quatpoints2.length-1]);
							Quatpoints3.push(Quatpoints3[Quatpoints3.length-1]);
							Quatpoints4.push(Quatpoints4[Quatpoints4.length-1]);
							labelString.push(0);
							labelString.push(1);
						} else
							for(var stringLoop = 0 ; stringLoop < datapoints1.length ; stringLoop++ )
								labelString.push(stringLoop);
	
						console.log(labelString);
						window.myLine.update();
						window.myLine2.update();

			});
		});

		var config = {
			type: 'line',
			data: {
				labels: labelString ,
				datasets: [{
					label: 'X',
					data: datapoints1,
					borderColor: window.chartColors.red,
					backgroundColor: 'rgba(0, 0, 0, 0)',
					fill: false,
				//	cubicInterpolationMode: 'monotone'
				}, {
					label: 'Y',
					data: datapoints2,
					borderColor: window.chartColors.blue,
					backgroundColor: 'rgba(0, 0, 0, 0)',
					fill: false,
				}, {
					label: 'Z',
					data: datapoints3,
					borderColor: window.chartColors.green,
					backgroundColor: 'rgba(0, 0, 0, 0)',
					fill: false,
				//	lineTension: 0
				}]
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'Euler'
				},
				tooltips: {
					mode: 'index'
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Value'
						},
						ticks: {
							suggestedMin: minimumE,
							suggestedMax: maximumE,
						}
					}]
				}
			}
		};

		var config2 = {
			type: 'line',
			data: {
				labels: labelString ,
				datasets: [{
					label: 'W',
					data: Quatpoints1,
					borderColor: window.chartColors.red,
					backgroundColor: 'rgba(0, 0, 0, 0)',
					fill: false,
					cubicInterpolationMode: 'monotone'
				}, {
					label: 'I',
					data: Quatpoints2,
					borderColor: window.chartColors.blue,
					backgroundColor: 'rgba(0, 0, 0, 0)',
					fill: false,
				}, {
					label: 'J',
					data: Quatpoints3,
					borderColor: window.chartColors.green,
					backgroundColor: 'rgba(0, 0, 0, 0)',
					fill: false,
					lineTension: 0
				} , {
					label: 'K',
					data: Quatpoints4,
					borderColor: window.chartColors.orange,
					backgroundColor: 'rgba(0, 0, 0, 0)',
					fill: false,
					lineTension: 0
				}]
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'Quaternion'
				},
				tooltips: {
					mode: 'index'
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Value'
						},
						ticks: {
							suggestedMin: minimumQ,
							suggestedMax: maximumQ,
						}
					}]
				}
			}
		};

		window.onload = function() {

			var ctx = document.getElementById('canvas').getContext('2d');
			window.myLine = new Chart(ctx, config);

			var ctx2 = document.getElementById('canvas2').getContext('2d');
			window.myLine2 = new Chart(ctx2, config2);

		};
/*
		document.getElementById('randomizeData').addEventListener('click', function() {
			window.myLine.update();
		});
*/
	</script>

	<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin="anonymous"></script>
<!--  	<script src='app1.js'></script>	-->

<style>

	#QuatCanvas { display: inline-block; width: 45%; }
	#EulerCanvas { display: inline-block; width: 45%; }
	#csvQuat { display: inline-block; width: 45%; font-size: 1.2vw; }
	#csv { display: inline-block; width: 45%; font-size: 1.2vw; }
	@media only screen and (max-width: 800px) {
		#Instructions { font-size: 2.5vw; }
		#QuatCanvas { display: block; width: 90%; }
		#EulerCanvas { display: block; width: 90%; }
		#csvQuat { display: block; width: 99%; font-size: 2.5vw; }
		#csv { display: block; width: 99%; font-size: 2.5vw; }
	}

</style>

</body>

</html>

